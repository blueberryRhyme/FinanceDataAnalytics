{% extends "base.html" %}

{% block title %}Friends{% endblock %}

{% block head %}
<!-- No additional styles needed here as they're now in main.css -->
{% endblock %}

{% block content %}
<div class="page-container">
  <h1>Financial Friends & Challenges</h1>
  <p class="page-description">
    Compare your financial health with friends, join challenges, and earn badges for meeting your financial goals.
  </p>

  <!-- Leaderboard Section -->
  <div class="card">
    <h2 class="section-title">Friends Leaderboard</h2>
    <ul class="user-list">
      <li class="user-item">
        <div class="user-rank">1</div>
        <div class="user-avatar" style="background-color: #fbbf24;">S</div>
        <div class="user-info">
          <div class="user-name">Gilbert</div>
          <div class="user-streak">
            <span class="badge">3 month streak</span>
          </div>
        </div>
        <div class="user-score">92</div>
      </li>
      <li class="user-item user-you">
        <div class="user-rank">2</div>
        <div class="user-avatar">{{ current_user.username[0] }}</div>
        <div class="user-info">
          <div class="user-name">{{ current_user.username }} (You)</div>
          <div class="user-streak">
            <span class="badge">2 month streak</span>
          </div>
        </div>
        <div class="user-score">86</div>
      </li>
      <li class="user-item">
        <div class="user-rank">3</div>
        <div class="user-avatar" style="background-color: #8b5cf6;">M</div>
        <div class="user-info">
          <div class="user-name">Mark</div>
          <div class="user-streak">
            <span class="badge">1 month streak</span>
          </div>
        </div>
        <div class="user-score">78</div>
      </li>
      <li class="user-item">
        <div class="user-rank">4</div>
        <div class="user-avatar" style="background-color: #10b981;">J</div>
        <div class="user-info">
          <div class="user-name">Jia</div>
          <div class="user-streak">
            <span class="badge">New</span>
          </div>
        </div>
        <div class="user-score">65</div>
      </li>
    </ul>
  </div>

  <!-- Active Challenges -->
  <h2 class="section-title" style="align-self: flex-start; margin-left: 0;">Active Challenges</h2>
  <div class="challenges-container">
    <div class="challenge-card">
      <div class="challenge-title">Budget Champion</div>
      <div class="challenge-description">Stay under budget for 3 consecutive months</div>
      <div class="challenge-progress">
        <div class="progress-bar" style="width: 66%;"></div>
      </div>
      <div class="challenge-stat">
        <span>2/3 months</span>
        <span>+20 points</span>
      </div>
    </div>
    <div class="challenge-card">
      <div class="challenge-title">Savings Master</div>
      <div class="challenge-description">Save 15% of income for 2 months</div>
      <div class="challenge-progress">
        <div class="progress-bar" style="width: 50%;"></div>
      </div>
      <div class="challenge-stat">
        <span>1/2 months</span>
        <span>+15 points</span>
      </div>
    </div>
  </div>

  <!-- Friend Comparison -->
  <div class="card">
    <h2 class="section-title">Financial Health Comparison</h2>
    <p>Compare your financial health metrics with friends</p>
    <canvas id="comparisonChart" height="550"></canvas>
  </div>

  <!-- Spending Comparison -->
  <div class="card" style="max-width: 900px;">
    <h2 class="section-title">Monthly Spending Comparison</h2>
    <p>See how your spending in each category compares to your friends</p>
    <div class="chart-filters">
      <select id="month-selector" class="input-box" style="width: auto; display: inline-block;">
        <option value="april">April 2025</option>
        <option value="march">March 2025</option>
        <option value="february">February 2025</option>
      </select>
      <select id="friend-selector" class="input-box" style="width: auto; display: inline-block;">
        <option value="average">Average of All Friends</option>
        <option value="gilbert">Gilbert</option>
        <option value="mark">Mark</option>
        <option value="jia">Jia</option>
      </select>
    </div>
    <canvas id="spendingChart" height="450"></canvas>
  </div>

  <!-- Add Friend Section -->
  <div class="card">
    <h2 class="section-title">Add New Friends</h2>
    <form class="add-form" onsubmit="return false;">
      <input type="text" id="friend-email" placeholder="Enter friend's email..." style="padding: 12px 16px; border-radius: 8px; border: 1px solid #e2e8f0; width: 70%; margin-right: 10px;">
      <button class="btn">Invite Friend</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Create comparison chart
  window.addEventListener('DOMContentLoaded', function() {
    // Financial Health Radar Chart
    const radarCtx = document.getElementById('comparisonChart').getContext('2d');
    const comparisonChart = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ['Budgeting', 'Saving', 'Investing', 'Debt Management', 'Income Growth'],
        datasets: [
          {
            label: 'You',
            data: [85, 70, 60, 90, 75],
            fill: true,
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: '#3b82f6',
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#3b82f6'
          },
          {
            label: 'Average Friend',
            data: [65, 80, 70, 75, 80],
            fill: true,
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            borderColor: '#10b981',
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#10b981'
          }
        ]
      },
      options: {
        responsive: true,
        elements: {
          line: {
            borderWidth: 3
          }
        },
        scales: {
          r: {
            angleLines: {
              display: true
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        }
      }
    });
    
    // Monthly Spending Comparison Bar Chart
    const barCtx = document.getElementById('spendingChart').getContext('2d');
    const spendingData = {
      april: {
        average: [450, 280, 320, 150, 210, 180, 90],
        gilbert: [380, 230, 410, 120, 190, 150, 70],
        mark: [420, 310, 350, 180, 220, 200, 110],
        jia: [550, 300, 200, 150, 220, 190, 90]
      },
      march: {
        average: [470, 260, 340, 170, 230, 190, 100],
        gilbert: [400, 220, 430, 140, 180, 160, 80],
        mark: [440, 290, 370, 190, 240, 210, 120],
        jia: [570, 270, 220, 180, 230, 200, 100]
      },
      february: {
        average: [430, 300, 300, 160, 200, 170, 95],
        gilbert: [360, 250, 390, 130, 200, 140, 75],
        mark: [400, 330, 330, 170, 210, 190, 115],
        jia: [530, 320, 180, 140, 190, 180, 95]
      }
    };

    // Variables to track current selections
    let currentMonth = 'april';
    let currentFriend = 'average';
    
    // Function to update the chart based on selections
    function updateSpendingChart() {
      const spendingChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: ['Housing', 'Food', 'Transportation', 'Entertainment', 'Utilities', 'Shopping', 'Other'],
          datasets: [
            {
              label: 'Your Spending',
              data: [500, 300, 250, 200, 180, 150, 100],
              backgroundColor: '#3b82f6',
              borderColor: '#2563eb',
              borderWidth: 1
            },
            {
              label: currentFriend === 'average' ? 'Average Friend' : currentFriend.charAt(0).toUpperCase() + currentFriend.slice(1),
              data: spendingData[currentMonth][currentFriend],
              backgroundColor: '#10b981',
              borderColor: '#059669',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': $' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          }
        }
      });
      
      return spendingChart;
    }
    
    // Initial chart creation
    let spendingChart = updateSpendingChart();
    
    // Event listeners for selectors
    document.getElementById('month-selector').addEventListener('change', function(e) {
      currentMonth = e.target.value;
      spendingChart.destroy();
      spendingChart = updateSpendingChart();
    });
    
    document.getElementById('friend-selector').addEventListener('change', function(e) {
      currentFriend = e.target.value;
      spendingChart.destroy();
      spendingChart = updateSpendingChart();
    });
  });

</script>
{% endblock %}
