{% extends "base.html" %}
{% block title %}Friends{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="page-container">
  <h1>Financial Friends</h1>
  <p class="page-description">
    Connect with friends to share financial insights and view each other's dashboards.
  </p>
  
  <!-- ───── Add-friend search ───── -->
  <div class="card" style="margin-bottom: 20px;">
    <div class="card-header">
      <h3>Search for Friends</h3>
    </div>
    <div class="search-area" style="padding: 15px;">
      <input type="text" id="user-search" placeholder="Username or email address" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
      <div id="search-results" style="margin-top: 15px;"></div>
    </div>
  </div>

  <!-- ───── Friends list ───── -->
  <div class="card">
    <div class="card-header">
      <h3>Your Friends</h3>
    </div>
    <div style="padding: 15px;">
      <ul id="friend-list" class="user-list"></ul>
      <p id="no-friends" class="empty-message" style="color: #94a3b8; font-style: italic;">You don't have any friends yet. Search for users above to add friends.</p>
    </div>
  </div>
</div>

<!-- ───── Scripts ───── -->
<script>
// Get CSRF token for all API requests
const cfg = JSON.parse(document.getElementById('app-config').textContent || '{}');
const csrfToken = cfg.csrf || {{ csrf_token()|tojson }};

/* -----------------------------------------------------------
   Friends Management
----------------------------------------------------------- */
(function() {
  // DOM elements
  const $friendList = document.getElementById('friend-list');
  const $noFriends = document.getElementById('no-friends');
  const $search = document.getElementById('user-search');
  const $results = document.getElementById('search-results');
  
  function buildFriendRow(f) {
    const li = document.createElement('li');
    li.className = 'user-item';
    li.style.justifyContent = 'space-between';
    
    const span = document.createElement('span');
    span.textContent = f.username;
    
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'actions';
    
    // View dashboard button
    const viewBtn = document.createElement('button');
    viewBtn.className = 'btn btn--sm view-dashboard';
    viewBtn.textContent = 'View Dashboard';
    viewBtn.dataset.id = f.id;
    viewBtn.addEventListener('click', async () => {
      // Try to fetch the dashboard first
      const response = await fetch(`/shared_dashboard/${f.id}`);
      if (response.status === 403) {
        // Show a friendly popup message
        const friendName = f.username;
        alert(`${friendName} needs to add you as a friend too before you can view their dashboard. Friendship in FinShare requires mutual connection!`);
      } else {
        // If successful or any other error, navigate to the page
        window.location.href = `/shared_dashboard/${f.id}`;
      }
    });
    
    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn btn--sm';
    removeBtn.textContent = 'Remove';
    removeBtn.style.marginLeft = '10px';
    removeBtn.dataset.id = f.id;
    removeBtn.addEventListener('click', () => {
      if(confirm('Are you sure you want to remove this friend?')){
        removeFriend(f.id);
      }
    });
    
    actionsDiv.append(viewBtn, removeBtn);
    li.append(span, actionsDiv);
    return li;
  }
  
  // Load friends list
  async function loadFriends() {
    try {
      const r = await fetch('/api/friends');
      if(!r.ok) return;
      
      const data = await r.json();
      $friendList.innerHTML = '';
      
      if(!data.length){
        $noFriends.style.display = 'block';
        return;
      }
      
      $noFriends.style.display = 'none';
      data.forEach(f => {
        $friendList.appendChild(buildFriendRow(f));
      });
    } catch(error) {
      console.error('Error loading friends:', error);
    }
  }
  // Function to remove a friend
  function removeFriend(friendId) {
    fetch('/api/remove_friend', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ friend_id: friendId })
    })
    .then(response => {
      if (response.ok) {
        loadFriends();  // Refresh the friend list
      } else {
        alert('Failed to remove friend.');
      }
    })
    .catch(error => console.error('Error removing friend:', error));
  }
  
  // Search for users
  let debounce;
  function buildSearchRow(u) {
    const li = document.createElement('li');
    li.className = 'user-item';
    li.style.justifyContent = 'space-between';
    
    const span = document.createElement('span');
    span.textContent = u.username;
    
    const btn = document.createElement('button');
    btn.className = 'btn btn--sm';
    btn.dataset.id = u.id;
    
    if (u.is_friend) {
      btn.textContent = 'Friend ✓';
      btn.disabled = true;
      btn.style.opacity = 0.6;
    } else {
      btn.textContent = 'Add Friend';
    }
    
    li.append(span, btn);
    return li;
  }
  
  async function searchUsers(query) {
    if (!query) {
      $results.innerHTML = '';
      return;
    }
    
    try {
      const r = await fetch('/api/user_search?q=' + encodeURIComponent(query));
      if (r.ok) {
        const users = await r.json();
        $results.innerHTML = '';
        
        if (!users.length) {
          $results.innerHTML = '<p style="padding:8px 0;color:#94a3b8">No users found</p>';
          return;
        }
        
        const list = document.createElement('ul');
        list.className = 'user-list';
        users.forEach(u => list.append(buildSearchRow(u)));
        $results.append(list);
      }
    } catch (error) {
      console.error('Search error:', error);
      $results.innerHTML = '<p>An error occurred during search.</p>';
    }
  }
  
  // Search as user types
  $search.addEventListener('input', e => {
    clearTimeout(debounce);
    debounce = setTimeout(() => searchUsers(e.target.value.trim()), 300);
  });
  
  // Handle search result clicks (add friend)
  $results.addEventListener('click', async e => {
    const btn = e.target.closest('button[data-id]');
    if (!btn || btn.disabled) return;
    
    btn.disabled = true;
    const r = await fetch('/api/add_friend', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json', 
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        friend_id: parseInt(btn.dataset.id, 10)
      })
    });
    
    if (r.ok) {
      btn.textContent = 'Friend ✓';
      btn.style.opacity = 0.6;
      loadFriends(); // Refresh the friends list
    } else {
      btn.disabled = false;
      alert('Could not add friend — try again.');
    }
  });
  
  // Load friends on page load
  loadFriends();
  
  // Initialize the page
  loadFriends();
})();
</script>
{% endblock %}