{% extends "base.html" %}

{% block title %}Your Profile{% endblock %}

{%block head %}
<!-- No additional styles needed here as they're now in main.css -->
{% endblock %}

{% block content %}
<div class="page-container">
  <h1>Welcome, {{ current_user.username }}!</h1>
  
  <div class="card">
    <p><strong>Email:</strong> {{ current_user.email }}</p>
    
    <form action="{{ url_for('main.logout') }}" method="post" style="text-align: right; margin-top: 10px;">
      {{ logout_form.csrf_token }}
      {{ logout_form.submit(class="button-small") }}
    </form>
  </div>

  <div class="profile-content-container">
  <section class="profile-section">
    <h2>Financial Goals</h2>
    <div class="card">
      <div class="goal-list" id="goal-list">
        <!-- Sample goals -->
        <div class="goal-item">Buy a new car - $30,000 by 2025-01-01</div>
        <div class="goal-item">Save for vacation - $5,000 by 2025-12-01</div>
        <!-- Existing goals can be dynamically populated here -->
        {% for goal in current_user.goals %}
          <div class="goal-item">{{ goal.name }} - ${{ goal.amount }} by {{ goal.target_date }}</div>
        {% endfor %}
      </div>

      <!-- Add New Goal Form -->
      <form class="add-form" onsubmit="addGoal(event)">
        <h3 class="section-title">Add New Goal</h3>
        <input type="text" id="goal-name" placeholder="Goal Name" class="input-box" required>
        <input type="number" id="target-amount" placeholder="Target Amount ($)" class="input-box" required>
        <input type="date" id="target-date" class="input-box" required>

        <button type="submit" class="button">Add Goal</button>
      </form>
    </div>
  </section>

  <section class="profile-section">
    <h2>Friends List</h2>
    <div class="card">
      <div class="friend-list" id="friend-list">
        <!-- Sample friends -->
        <div class="friend-item">Mark</div>
        <div class="friend-item">Jia</div>
        <!-- Existing friends can be dynamically populated here -->
        {% for friend in current_user.friends %}
          <div class="friend-item">{{ friend.username }}</div>
        {% endfor %}
      </div>

      <!-- Add New Friend Form -->
      <form class="add-form" onsubmit="addFriend(event)">
        <h3 class="section-title">Add New Friend</h3>
        <input type="text" id="friend-name" placeholder="Enter friend's name..." class="input-box" required>
        <button type="submit" class="button">Add Friend</button>
      </form>
    </div>
  </section>

  <script>
    // Function to add a new goal to the list dynamically
    function addGoal(event) {
      event.preventDefault();  // Prevent form from submitting

      // Get the input values
      const goalName = document.getElementById('goal-name').value;
      const targetAmount = document.getElementById('target-amount').value;
      const targetDate = document.getElementById('target-date').value;

      // Create a new goal item element
      const newGoalItem = document.createElement('div');
      newGoalItem.classList.add('goal-item');
      newGoalItem.textContent = `${goalName} - $${targetAmount} by ${targetDate}`;

      // Append the new goal item to the goal list
      document.getElementById('goal-list').appendChild(newGoalItem);

      // Clear the input fields
      document.getElementById('goal-name').value = '';
      document.getElementById('target-amount').value = '';
      document.getElementById('target-date').value = '';
    }

    // Function to add a new friend to the list dynamically
    function addFriend(event) {
      event.preventDefault();  // Prevent form from submitting

      // Get the input value
      const friendName = document.getElementById('friend-name').value;

      // Create a new friend item element
      const newFriendItem = document.createElement('div');
      newFriendItem.classList.add('friend-item');
      newFriendItem.textContent = friendName;

      // Append the new friend item to the friend list
      document.getElementById('friend-list').appendChild(newFriendItem);

      // Clear the input field
      document.getElementById('friend-name').value = '';
    }

    

 
    document.addEventListener('DOMContentLoaded', () => {
      fetch('/api/expenses')
        .then(res => {
          if (!res.ok) throw new Error(res.statusText);
          return res.json();
        })
        .then(expenses => {
          const list = document.getElementById('expense-list');
          expenses.forEach(exp => {
            const li = document.createElement('li');
            li.textContent = 
              `${exp.date} â€” ${exp.category}: $${exp.amount.toFixed(2)}`;
            list.appendChild(li);
          });
        })
        .catch(err => console.error('Error loading expenses:', err));
    });

    document.addEventListener("DOMContentLoaded", () => {
      const token = document.querySelector('meta[name="csrf-token"]').content;

      document.body.addEventListener("click", async e => {
        if (!e.target.matches(".remove-friend-btn")) return;

        const btn    = e.target;
        const item   = btn.closest(".friend-item");
        const userId = item.dataset.userId;

        try {
          const resp = await fetch(`/remove_friend/${userId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": token
            }
          });
          if (!resp.ok) throw new Error("Failed to remove friend");

          item.remove();
        } catch (err) {
          console.error(err);
          alert("Could not remove friend. Try again.");
        }
      });
  });
  </script>
  {% endblock %}


