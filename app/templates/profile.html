{% extends "base.html" %}

{% block title %}Your Profile{% endblock %}

{%block head %}
<!-- No additional styles needed here as they're now in main.css -->
{% endblock %}

{% block content %}
<div class="page-container">
  <h1>Welcome, {{ current_user.username }}!</h1>
  
  <div class="card">
    <p><strong>Email:</strong> {{ current_user.email }}</p>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
      <a href="{{ url_for('main.achievements') }}" class="button-small" style="text-decoration: none; background-color: #3b82f6; color: white; padding: 8px 16px; border-radius: 4px;">View Achievements</a>
      
      <form action="{{ url_for('main.logout') }}" method="post" style="margin: 0;">
        {{ logout_form.csrf_token }}
        {{ logout_form.submit(class="button-small") }}
      </form>
    </div>
  </div>

  <div class="profile-content-container">
  
    <div class="card">
      <h2 class="section-title">Budget Settings</h2>
      <!-- Display fields -->
      <div class="goal-list" id="goal-list">
        <div class=" goal-item">Your Monthly Budget:
          $<span id="current-budget">{{ current_user.settings.monthly_budget }}</span>
        </div>
          
        <div class = "goal-item">
          <label>
            Currency:
            <select id="currency-select" class="input-box">
              {% for code,name in [('AUD','Australian Dollar'),('USD','US Dollar'),('EUR','Euro')] %}
                <option value="{{ code }}" {% if current_user.currency==code %}selected{% endif %}>
                  {{ code }} — {{ name }}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>

        <div class="goal-item">
          <label >
          Monthly Budget: $
            <input id="budget-input" type="number" min="0" step="0.01"
                  class="input-box"
                  value="{{ current_user.budget }}">
          </label>
          <button id="save-settings" class="btn" style="margin-left:1rem">
            Save
          </button>
        </div>  

      </div>
    </div>
    
    <!-- My Goals Section -->
    <div class="card">
      <div class="my-goals-header">
        <h2 class="section-title">My Goals</h2>
        <a href="{{ url_for('main.new_goal') }}" class="button-primary">Create New Goal</a>
      </div>
      
      <div class="my-goals-container">
        {% if user_goals %}
          {% for goal in user_goals %}
            <div class="my-goal-card">
              <div class="goal-info">
                <h3>{{ goal.title }}</h3>
                {% if goal.description %}
                  <p class="goal-description">{{ goal.description }}</p>
                {% endif %}
                
                {% if goal.target_date %}
                  <div class="goal-deadline">Target: {{ goal.target_date.strftime('%b %d, %Y') }}</div>
                {% endif %}
                
                <div class="goal-badges">
                  {% if goal.is_public %}
                    <span class="badge public">Public</span>
                  {% else %}
                    <span class="badge private">Private</span>
                  {% endif %}
                  
                  {% if goal.is_completed %}
                    <span class="badge completed">Completed</span>
                  {% endif %}
                </div>
              </div>
              
              <div class="goal-metrics">
                <div class="goal-amount">
                  <div class="amount-labels">
                    <span class="amount-target">${{ "%.2f"|format(goal.target_amount) }}</span>
                    <span class="amount-current">${{ "%.2f"|format(goal.current_amount) }}</span>
                  </div>
                  <div class="progress-wrapper">
                    <div class="progress-bar" style="width: {{ goal.progress_percentage() }}%"></div>
                  </div>
                  <div class="goal-progress">{{ "%.1f"|format(goal.progress_percentage()) }}% Complete</div>
                </div>
              </div>
              
              <div class="goal-actions">
                <a href="{{ url_for('main.edit_goal', goal_id=goal.id) }}" class="action-button edit">Edit</a>
                <form method="POST" action="{{ url_for('main.delete_goal', goal_id=goal.id) }}" style="display: inline;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="action-button delete" onclick="return confirm('Are you sure you want to delete this goal?')">Delete</button>
                </form>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-goals">
            <p>You haven't set any financial goals yet.</p>
            <p>Setting goals helps you track your financial progress and stay motivated!</p>
            <a href="{{ url_for('main.new_goal') }}" class="button-primary">Create Your First Goal</a>
          </div>
        {% endif %}
      </div>
    </div>
      

<script>

const cfg       = JSON.parse(document.getElementById('app-config').textContent);
const CSRF = cfg.csrf; 

  document.getElementById('save-settings').addEventListener('click', async () => {
    const currency = document.getElementById('currency-select').value;
    const budget   = parseFloat(document.getElementById('budget-input').value);

    // Basic validation
    if (isNaN(budget) || budget < 0) {
      alert('Please enter a valid non-negative budget.');
      return;
    }

    const btn = event.currentTarget;
    btn.disabled = true;
    btn.textContent = 'Saving…';

    // Send AJAX
    const res = await fetch('/api/update_settings', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRF
      },
      body: JSON.stringify({ currency, budget })
    });

    btn.disabled = false;
    btn.textContent = 'Save';

    if (res.ok) {
      const data = await res.json();
      // Update the display spans
      document.getElementById('current-budget').textContent = data.budget.toFixed(2);
      document.getElementById('budget-input').value      = data.budget.toFixed(2);

      // Show confirmation message
      const msg = document.getElementById('settings-msg');
      msg.textContent = 'Settings updated!';
      msg.style.display = 'block';
      setTimeout(() => { msg.style.display = 'none'; }, 3000);
    } else {
      const err = await res.text();
      alert('Update failed: ' + err);
    }
  });





    // Function to add a new goal to the list dynamically
    function addGoal(event) {
      event.preventDefault();  // Prevent form from submitting

      // Get the input values
      const goalName = document.getElementById('goal-name').value;
      const targetAmount = document.getElementById('target-amount').value;
      const targetDate = document.getElementById('target-date').value;

      // Create a new goal item element
      const newGoalItem = document.createElement('div');
      newGoalItem.classList.add('goal-item');
      newGoalItem.textContent = `${goalName} - $${targetAmount} by ${targetDate}`;

      // Append the new goal item to the goal list
      document.getElementById('goal-list').appendChild(newGoalItem);

      // Clear the input fields
      document.getElementById('goal-name').value = '';
      document.getElementById('target-amount').value = '';
      document.getElementById('target-date').value = '';
    }
    
    

 

    document.addEventListener("DOMContentLoaded", () => {



      document.body.addEventListener("click", async e => {
        if (!e.target.matches(".remove-friend-btn")) return;

        const btn    = e.target;
        const item   = btn.closest(".friend-item");
        const userId = item.dataset.userId;

        try {
          const resp = await fetch(`/remove_friend/${userId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": CSRF
            }
          });
          if (!resp.ok) throw new Error("Failed to remove friend");

          item.remove();
        } catch (err) {
          console.error(err);
          alert("Could not remove friend. Try again.");
        }
      });
  });
  </script>

<style>
  /* Profile page styles */
  .section-title {
    color: #3b82f6;
    font-size: 1.5rem;
    margin-bottom: 1.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .my-goals-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .button-primary {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: #3b82f6;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 500;
  }

  .my-goals-container {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .my-goal-card {
    padding: 1.25rem 2rem;
    background: white;
    border-radius: 15px;
    border-left: 6px solid #2563eb;
    display: grid;
    grid-template-columns: 2fr 3fr 1fr;
    grid-gap: 1.5rem;
    align-items: center;
    margin-bottom: 1rem;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .my-goal-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }

  .goal-info {
    width: 100%;
    margin-bottom: 0;
  }

  .goal-info h3 {
    font-size: 1.4rem;
    margin-top: 0;
    margin-bottom: 0.5rem;
    color: #1e293b;
    font-weight: 600;
  }

  .goal-description {
    color: #475569;
    font-size: 1rem;
    margin-bottom: 0.75rem;
    line-height: 1.4;
  }

  .goal-metrics {
    width: 100%;
    margin-bottom: 1.25rem;
  }

  .goal-amount {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }

  .amount-labels {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  .amount-target {
    font-weight: 600;
    font-size: 1.1rem;
    color: #1f2937;
  }

  .amount-current {
    font-weight: 600;
    font-size: 1.1rem;
    color: #3b82f6;
  }

  .progress-wrapper {
    width: 100%;
    height: 10px;
    background: #e5e7eb;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 0.25rem;
    margin-bottom: 0.5rem;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(to right, #3b82f6, #60a5fa);
    border-radius: 5px;
    transition: width 0.5s ease;
  }
  
  .goal-progress {
    font-size: 1.1rem;
    font-weight: 500;
    color: #4b5563;
    text-align: center;
    margin-bottom: 1rem;
  }

  .goal-deadline {
    font-size: 0.9rem;
    color: #4b5563;
    margin-top: 0.5rem;
    margin-bottom: 0.75rem;
    font-weight: 500;
  }

  .goal-badges {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    margin-bottom: 0;
  }

  .my-goals-section {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  .badge {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .badge.public {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
  }

  .badge.private {
    background: #f3f4f6;
    color: #4b5563;
    border: 1px solid #e5e7eb;
  }

  .badge.completed {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }
  
  .my-goals-header h2 {
    font-size: 1.75rem;
    margin: 0;
    color: #1f2937;
  }

  .goal-actions {
    display: flex;
    flex-direction: row;
    gap: 0.75rem;
    justify-content: flex-end;
    align-items: center;
  }

  .action-button {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-align: center;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s ease;
  }

  .action-button.edit {
    background: white;
    color: #3b82f6;
    border: 2px solid #3b82f6;
  }

  .action-button.edit:hover {
    background: #dbeafe;
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(59, 130, 246, 0.2);
  }

  .action-button.delete {
    background: white;
    color: #ef4444;
    border: 2px solid #ef4444;
  }
  
  .action-button.delete:hover {
    background: #fee2e2;
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(239, 68, 68, 0.2);
  }

  .no-goals {
    text-align: center;
    padding: 2rem;
    background: #f9fafb;
    border-radius: 6px;
  }

  .no-goals p {
    color: #6b7280;
    margin-bottom: 0.75rem;
  }

  .no-goals p:last-of-type {
    margin-bottom: 1.5rem;
  }
</style>
  {% endblock %}