{% extends "base.html" %}

{% block title %}Transactions{% endblock %}

{% block content %}
<div class="page-container">
  <h1>Your Transactions</h1>
  <p class="page-description">View, categorize, or delete your transactions.</p>

  <table class="transaction-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>Category</th>
        <th>Amount</th>
        <th>Type</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for tx in transactions %}
      <tr>
        <td>{{ tx.date }}</td>
        <td>{{ tx.description }}</td>
        <td>
          {% if tx.category == 'Uncategorized' %}
          <form method="POST" style="display: inline;">
            {{ form.csrf_token }}
            <input type="hidden" name="transaction_id" value="{{ tx.id }}">
            <input type="hidden" name="action" value="update">
            <select name="category" id="category-{{ tx.id }}" onchange="updateCategory('{{ tx.id }}', this.value)">
              <option value="Uncategorized" {% if tx.category == 'Uncategorized' %}selected{% endif %}>Uncategorized</option>
              <option value="Food" {% if tx.category == 'Food' %}selected{% endif %}>Food</option>
              <option value="Shopping" {% if tx.category == 'Shopping' %}selected{% endif %}>Shopping</option>
              <option value="Health" {% if tx.category == 'Health' %}selected{% endif %}>Health</option>
              <option value="Salary" {% if tx.category == 'Salary' %}selected{% endif %}>Salary</option>
              <option value="Savings" {% if tx.category == 'Savings' %}selected{% endif %}>Savings</option>
              <option value="Refund" {% if tx.category == 'Refund' %}selected{% endif %}>Refund</option>
              <option value="Other" {% if tx.category == 'Other' %}selected{% endif %}>Other</option>
          </select>
          </form>
          {% else %}
          {{ tx.category }}
          {% endif %}
        </td>
        <td>${{ "%.2f"|format(tx.amount) }}</td>
        <td>{{ tx.type.value }}</td>
        <td>
          <form method="POST" style="display: inline;">
            {{ form.csrf_token }}
            <input type="hidden" name="transaction_id" value="{{ tx.id }}">
            <input type="hidden" name="action" value="delete">
            <button type="submit" class="button-small danger">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function updateCategory(transactionId, newCategory) {
        try {
            const response = await fetch('/api/update_transaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ form.csrf_token._value() }}' // Include CSRF token
                },
                body: JSON.stringify({
                    transaction_id: transactionId,
                    category: newCategory
                })
            });

            const result = await response.json();
            if (!response.ok) {
                alert(result.error || 'Failed to update category');
            } else {
                alert('Category updated successfully!');
            }
        } catch (error) {
            console.error('Error updating category:', error);
            alert('An error occurred while updating the category.');
        }
    }
</script>
{% endblock %}